<!DOCTYPE html>
<html lang="en" class="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Enhanced Chain of Draft Studio - Multi-Model Reasoning</title>
  
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
  
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  
  <!-- Marked.js for Markdown parsing -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  
  <!-- Highlight.js for code highlighting -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/styles/github-dark.min.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.7.0/highlight.min.js"></script>
  
  <!-- Configuration for Tailwind -->
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            primary: { 50: '#eef2ff', 100: '#e0e7ff', 200: '#c7d2fe', 300: '#a5b4fc', 400: '#818cf8', 500: '#5686f5', 600: '#4f46e5', 700: '#4338ca', 800: '#3730a3', 900: '#312e81', 950: '#1e1b4b' },
            dark: { 100: '#d1d5db', 200: '#9ca3af', 300: '#6b7280', 400: '#4b5563', 500: '#374151', 600: '#1f2937', 700: '#111827', 800: '#0d1117', 900: '#030712' },
            deepseek: { 100: '#f0f9ff', 200: '#e0f2fe', 300: '#7dd3fc', 400: '#38bdf8', 500: '#0ea5e9', 600: '#0284c7', 700: '#0369a1', 800: '#075985', 900: '#0c4a6e' }
          },
          fontFamily: {
            sans: ['Inter', 'ui-sans-serif', 'system-ui', 'sans-serif'],
            mono: ['JetBrains Mono', 'ui-monospace', 'monospace'],
          },
        }
      }
    };
  </script>

  <style>
    :root { --deepseek: #0ea5e9; }
    ::-webkit-scrollbar { width: 6px; height: 6px; }
    ::-webkit-scrollbar-track { background: rgb(20, 24, 33); border-radius: 8px; }
    ::-webkit-scrollbar-thumb { background: rgba(14, 165, 233, 0.6); border-radius: 8px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(14, 165, 233, 0.8); }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .cod-step, .final-answer, .verification-block { animation: fadeIn 0.5s ease forwards; }
    @keyframes pulse { 0% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0.7); } 70% { box-shadow: 0 0 0 10px rgba(14, 165, 233, 0); } 100% { box-shadow: 0 0 0 0 rgba(14, 165, 233, 0); } }
    .stage-indicator { animation: pulse 2s infinite; }
    .progress-bar { background: linear-gradient(90deg, #0ea5e9 0%, #0284c7 100%); transition: width 0.3s ease; }
    input[type="range"] { -webkit-appearance: none; width: 100%; height: 4px; background: #1f2937; border-radius: 4px; outline: none; background: linear-gradient(to right, var(--deepseek) var(--value-percent, 50%), #1f2937 var(--value-percent, 50%)) !important; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; margin-top: -6px; width: 16px; height: 16px; background: white !important; border-radius: 50%; cursor: pointer; border: 1px solid rgba(0,0,0,0.1) !important; box-shadow: 0 1px 2px rgba(0,0,0,0.1); }
    .deepseek-gradient { background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 50%, #075985 100%); }
    .deepseek-glow { box-shadow: 0 0 20px rgba(14, 165, 233, 0.3); }
    pre code.hljs{ padding: 1rem; border-radius: 0.5rem; }
    .copy-btn-added { position: relative; }
    .copy-btn { position: absolute; top: 0.5rem; right: 0.5rem; background-color: rgba(42, 50, 61, 0.7); color: #d1d5db; padding: 0.25rem 0.5rem; border-radius: 0.375rem; font-size: 0.75rem; transition: background-color 0.2s; }
    .copy-btn:hover { background-color: rgba(55, 65, 81, 0.9); }
  </style>
</head>
<body class="bg-dark-800 text-gray-100 font-sans min-h-screen overflow-hidden">
  <div class="flex h-screen">
    <!-- Sidebar -->
    <div class="w-80 bg-gradient-to-b from-dark-700 to-dark-800 border-r border-dark-600 flex flex-col overflow-y-auto hidden md:flex shadow-2xl">
      <!-- Header -->
      <div class="p-6 border-b border-dark-600/50">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-10 h-10 deepseek-gradient rounded-lg flex items-center justify-center deepseek-glow">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path></svg>
          </div>
          <div>
            <h2 class="text-lg font-bold text-white">Enhanced CoD Studio</h2>
            <p class="text-xs text-deepseek-300">Multi-Model Reasoning</p>
          </div>
        </div>
        <button id="newThreadBtn" class="w-full deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white py-3 px-4 rounded-xl transition-all duration-200 flex items-center justify-center gap-3 shadow-lg hover:shadow-xl transform hover:scale-105 deepseek-glow">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
          <span class="font-medium">New Research Session</span>
        </button>
      </div>
      <!-- System Status -->
      <div class="p-4 border-b border-dark-600/50">
        <div class="bg-gradient-to-r from-deepseek-900/20 to-blue-900/20 border border-deepseek-500/30 rounded-lg p-3 mb-3">
          <div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><div class="w-2 h-2 bg-deepseek-400 rounded-full animate-pulse"></div><span class="text-deepseek-300 text-sm font-medium">S1: DeepSeek V3</span></div><span class="text-deepseek-400 text-xs bg-deepseek-900/30 px-2 py-1 rounded-full">Active</span></div>
          <div class="text-deepseek-200 text-xs">Analysis & Draft Generation</div>
        </div>
        <div class="bg-gradient-to-r from-purple-900/20 to-indigo-900/20 border border-purple-500/30 rounded-lg p-3 mb-3">
          <div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div><span class="text-purple-300 text-sm font-medium">S2: Qwen3-30b</span></div><span class="text-purple-400 text-xs bg-purple-900/30 px-2 py-1 rounded-full">Active</span></div>
          <div class="text-purple-200 text-xs">Verification & Refinement</div>
        </div>
        <div class="bg-gradient-to-r from-green-900/20 to-emerald-900/20 border border-green-500/30 rounded-lg p-3">
          <div class="flex items-center justify-between mb-2"><div class="flex items-center gap-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-green-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg><span class="text-green-300 text-sm font-medium">Memory Active</span></div><span id="memoryCount" class="text-green-400 text-xs bg-green-900/30 px-2 py-1 rounded-full">0 items</span></div>
          <div class="text-green-200 text-xs">Storing conversations & preferences</div>
        </div>
      </div>
      <!-- Threads Section -->
      <div class="flex-1 p-4">
        <div class="flex items-center justify-between mb-3"><h3 class="text-sm font-medium text-gray-300 uppercase tracking-wider">Recent Sessions</h3><span id="threadCount" class="text-xs bg-dark-600 text-gray-400 px-2 py-1 rounded-full">1</span></div>
        <ul id="threadList" class="space-y-2 mb-6"></ul>
      </div>
      <!-- Actions Section -->
      <div class="p-4 border-t border-dark-600/50 space-y-3">
        <button id="clearThreadBtn" class="w-full bg-dark-600 hover:bg-dark-500 text-gray-300 hover:text-white py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-3 border border-dark-500 hover:border-gray-500"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="text-sm">Clear Session</span></button>
        <button id="deleteThreadBtn" class="w-full bg-red-600/20 hover:bg-red-600/30 text-red-400 hover:text-red-300 py-2.5 px-4 rounded-lg transition-all duration-200 flex items-center gap-3 border border-red-600/20 hover:border-red-500/50"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg><span class="text-sm">Delete Session</span></button>
      </div>
    </div>

    <!-- Main Content Area -->
    <div class="flex-1 flex flex-col overflow-hidden">
      <!-- Header -->
      <header class="bg-dark-700 border-b border-dark-600 h-16 flex items-center justify-between px-4 md:px-6">
        <h1 id="pageTitle" class="text-xl font-semibold">Enhanced CoD Studio - Multi-Model</h1>
        <div class="flex items-center gap-3">
          <div id="currentModelDisplay" class="bg-dark-600 text-sm px-3 py-1.5 rounded-lg flex items-center gap-2">
            <div class="w-2 h-2 bg-deepseek-400 rounded-full animate-pulse"></div><span id="modelDisplayText">S1: DeepSeek V3</span><span class="mx-1 text-gray-500">|</span>
            <div class="w-2 h-2 bg-purple-400 rounded-full animate-pulse"></div><span id="stage2ModelDisplayText">S2: Qwen3</span>
          </div>
          <button id="openSettings" class="flex items-center gap-1.5 bg-dark-600 hover:bg-dark-500 text-gray-300 px-3 py-1.5 rounded-lg transition">
            <span>Settings</span>
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
          </button>
        </div>
      </header>
      <!-- Progress Bar -->
      <div id="progressContainer" class="bg-dark-600 h-2 overflow-hidden hidden"><div id="progressBar" class="progress-bar h-full w-0"></div></div>
      <!-- Chat Messages Area -->
      <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-6"></div>
      <!-- Input Area -->
      <div class="p-4 border-t border-dark-600 bg-dark-700">
        <div class="flex items-start gap-3 rounded-xl bg-dark-600 p-3 shadow-lg border border-dark-500 focus-within:border-deepseek-500 transition">
          <textarea id="userInput" rows="1" class="w-full bg-transparent text-gray-100 p-2 focus:outline-none resize-none text-base" placeholder="Ask a complex research question for multi-stage CoD reasoning..."></textarea>
          <button id="sendBtn" class="deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white p-3 rounded-lg transition deepseek-glow self-end">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10.894 2.553a1 1 0 00-1.788 0l-7 14a1 1 0 001.169 1.409l5-1.429A1 1 0 009 15.571V11a1 1 0 112 0v4.571a1 1 0 00.725.962l5 1.428a1 1 0 001.17-1.408l-7-14z"></path></svg>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Status Notification -->
  <div id="statusNotification" class="fixed bottom-4 right-4 bg-dark-600 text-white py-2 px-4 rounded-lg shadow-lg opacity-0 transition-opacity duration-300 z-50"></div>

  <!-- Settings Modal -->
  <div id="settingsModal" class="fixed inset-0 bg-black/70 backdrop-blur-sm flex items-center justify-center z-50 hidden">
    <div class="bg-dark-700 rounded-xl shadow-2xl max-w-5xl w-full mx-4 max-h-[90vh] flex flex-col">
      <div class="p-5 border-b border-dark-600 flex justify-between items-center flex-shrink-0">
        <h2 class="text-xl font-semibold">Enhanced AI Configuration</h2>
        <button id="closeModalX" class="text-gray-400 hover:text-white">√ó</button>
      </div>
      <div class="p-5 overflow-y-auto">
        <!-- Tab Navigation -->
        <div class="bg-dark-600 rounded-lg p-1 flex mb-5 overflow-x-auto"><button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-white bg-deepseek-500" data-tab="modelTab">ü§ñ Models</button><button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="codTab">üß† CoD Settings</button><button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="parametersTab">‚öôÔ∏è Parameters</button><button class="tab-btn flex-shrink-0 py-2 px-4 rounded-md text-gray-400 transition" data-tab="reflectionTab">üîÑ Reflection</button></div>
        <!-- Model Selection Tab -->
        <div id="modelTab" class="tab-content">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Model Configuration</h3>
          <div class="mb-6"><div class="bg-gradient-to-r from-deepseek-900/20 to-blue-900/20 border border-deepseek-500/30 rounded-lg p-4"><div class="flex items-center text-deepseek-300 text-sm font-medium mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Stage 1: DeepSeek V3 (Analysis & Draft)<span class="bg-deepseek-600/20 text-deepseek-300 text-xs px-2 py-1 rounded-full ml-2">FIREWORKS.AI</span></div><input type="text" id="modelPathStage1" value="accounts/fireworks/models/deepseek-v3-0324" readonly class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-deepseek-500 font-mono"><div class="text-deepseek-100 text-xs space-y-1 mt-2"><p>‚Ä¢ Optimized for complex problem-solving and initial reasoning.</p></div></div></div>
          <div class="mb-6"><div class="bg-gradient-to-r from-purple-900/20 to-indigo-900/20 border border-purple-500/30 rounded-lg p-4"><div class="flex items-center text-purple-300 text-sm font-medium mb-2"><svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>Stage 2: Qwen3-30b (Verification & Refinement)<span class="bg-purple-600/20 text-purple-300 text-xs px-2 py-1 rounded-full ml-2">FIREWORKS.AI</span></div><input type="text" id="modelPathStage2" value="accounts/fireworks/models/qwen3-30b-a3b" readonly class="w-full bg-dark-700 text-gray-100 rounded-lg p-3 text-sm focus:outline-none focus:ring-2 focus:ring-purple-500 font-mono"><div class="text-purple-100 text-xs space-y-1 mt-2"><p>‚Ä¢ Strong analytical model for verification and refining solutions.</p></div></div></div>
        </div>
        <!-- CoD Settings Tab -->
        <div id="codTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">CoD Configuration</h3>
          <div class="bg-dark-600 border border-dark-500 rounded-lg p-4 mb-5"><h4 class="text-sm font-medium text-gray-300 mb-3">Reasoning Method</h4><div class="space-y-3"><div class="flex items-start"><input type="radio" id="standardReasoning" name="reasoningMethod" value="standard" class="w-4 h-4 mt-1"><label for="standardReasoning" class="ml-3 block text-sm font-medium text-white">Standard (Single Model)<div class="text-gray-400 text-xs mt-1">Direct response from Stage 1 model.</div></label></div><div class="flex items-start"><input type="radio" id="enhancedCod" name="reasoningMethod" value="enhanced_cod" checked class="w-4 h-4 mt-1"><label for="enhancedCod" class="ml-3 block text-sm font-medium text-white">Chain of Draft (Multi-Model)<div class="text-gray-400 text-xs mt-1">Stage 1 drafts, Stage 2 refines.</div></label></div></div></div>
          <div id="codWordLimitSection" class="mb-5"><h4 class="text-sm font-medium text-gray-300 mb-3">CoD Word Limit (Per Step)</h4><div class="bg-dark-600 border border-dark-500 rounded-lg p-4 space-y-3"><p class="text-gray-400 text-xs mb-2">Forcing 15 words per step for concise, detailed intermediate thoughts.</p><div class="flex items-start"><input type="radio" id="cod15Words" name="codWordLimit" value="15" checked class="w-4 h-4 mt-1"><label for="cod15Words" class="ml-3 block text-sm font-medium text-white">15 words per step<div class="text-gray-400 text-xs mt-1">Fixed limit for this configuration.</div></label></div></div></div>
        </div>
        <!-- Parameters Tab -->
        <div id="parametersTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">LLM Parameters</h3>
          <div class="mb-4"><div class="flex justify-between items-center mb-2"><label for="temp" class="block text-sm font-medium text-gray-300">Temperature</label><span id="tempValue" class="text-sm text-gray-400">0.3</span></div><input type="range" id="temp" min="0" max="2" step="0.01" value="0.3" class="w-full h-2 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 mt-1">Controls randomness. Lower is more deterministic.</p></div>
          <div class="mb-4"><div class="flex justify-between items-center mb-2"><label for="topP" class="block text-sm font-medium text-gray-300">Top P</label><span id="topPValue" class="text-sm text-gray-400">0.9</span></div><input type="range" id="topP" min="0" max="1" step="0.01" value="0.9" class="w-full h-2 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 mt-1">Controls diversity via nucleus sampling.</p></div>
          <div class="mb-4"><div class="flex justify-between items-center mb-2"><label for="maxTokens" class="block text-sm font-medium text-gray-300">Max Tokens</label><span id="maxTokensValue" class="text-sm text-gray-400">8192</span></div><input type="range" id="maxTokens" min="1" max="16384" step="128" value="8192" class="w-full h-2 rounded-lg appearance-none cursor-pointer"><p class="text-xs text-gray-500 mt-1">Max length of the response for each stage.</p></div>
        </div>
        <!-- Reflection Tab -->
        <div id="reflectionTab" class="tab-content hidden">
          <h3 class="text-lg font-medium mb-4 pb-2 border-b border-dark-600">Stage 2 Refinement Directives</h3>
          <div class="space-y-3">
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition"><input type="checkbox" id="enableSelfVerification" checked class="w-4 h-4 mt-1"><div class="ml-3"><div class="font-medium text-white">Self-Verification</div><div class="text-gray-400 text-xs mt-1">Stage 2 model checks its own logic and Stage 1's logic.</div></div></label>
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition"><input type="checkbox" id="enableErrorDetection" checked class="w-4 h-4 mt-1"><div class="ml-3"><div class="font-medium text-white">Error Detection & Correction</div><div class="text-gray-400 text-xs mt-1">Stage 2 actively searches for and corrects errors from Stage 1.</div></div></label>
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition"><input type="checkbox" id="enableAlternativeSearch" checked class="w-4 h-4 mt-1"><div class="ml-3"><div class="font-medium text-white">Alternative Approach Search</div><div class="text-gray-400 text-xs mt-1">Stage 2 explores alternative solution paths.</div></div></label>
              <label class="flex items-start p-3 bg-dark-600 rounded-lg border border-dark-500 cursor-pointer hover:border-indigo-500/50 transition"><input type="checkbox" id="enableConfidenceAssessment" checked class="w-4 h-4 mt-1"><div class="ml-3"><div class="font-medium text-white">Confidence Assessment</div><div class="text-gray-400 text-xs mt-1">Stage 2 evaluates confidence in the final answer.</div></div></label>
          </div>
        </div>
      </div>
      <div class="p-5 border-t border-dark-600 flex justify-end gap-3 flex-shrink-0">
        <button id="closeSettings" class="px-4 py-2 bg-dark-600 hover:bg-dark-500 text-gray-300 rounded-lg transition">Cancel</button>
        <button id="saveSettings" class="px-4 py-2 deepseek-gradient hover:from-deepseek-600 hover:to-deepseek-700 text-white rounded-lg transition">Save Settings</button>
      </div>
    </div>
  </div>

  <script>
    // --- CONFIGURATION ---
    const CONFIG = {
      stage1Model: "accounts/fireworks/models/deepseek-v3-0324",
      stage2Model: "accounts/fireworks/models/qwen3-30b-a3b",
      reasoningMethod: "enhanced_cod", 
      codWordLimit: 15,
      reflectionSettings: {
        enableSelfVerification: true,
        enableErrorDetection: true,
        enableAlternativeSearch: true,
        enableConfidenceAssessment: true,
      },
      temperature: 0.3, 
      topP: 0.9,
      maxTokens: 8192,
    };

    // --- STATE ---
    let threads = [];
    let currentThreadId = null;
    let threadCounter = 1;

    // --- PROMPTS ---
    const PROMPTS = {
      stage1: (wordLimit) => `You are an expert AI assistant for STAGE 1 analysis. Your goal is to meticulously analyze the user's request and create a concise step-by-step reasoning draft to solve it.
CRITICAL INSTRUCTIONS:
1.  **Analyze**: First, break down the user's entire problem into its core components.
2.  **Draft Steps**: Think step-by-step. For each thought, create a concise draft of no more than ${wordLimit} words. Use as many steps as needed.
3.  **Draft Solution**: After the steps, provide a complete draft of the solution (e.g., full code block).
FORMAT:
#### PROBLEM ANALYSIS
[Your detailed breakdown of the request.]
#### CHAIN OF DRAFT STEPS
CoD Step 1: [${wordLimit} words max]
CoD Step 2: [${wordLimit} words max]
[... more steps as needed ...]
#### DRAFT SOLUTION
[Your complete initial solution.]`,

      stage2: (reflectionConfig) => `You are an expert AI analyst for STAGE 2 verification. You will receive a user's problem and a STAGE 1 draft. Your task is to critically analyze the draft and produce a final, polished, and 100% correct answer.
CRITICAL INSTRUCTIONS:
1.  **Verify**: Examine the STAGE 1 analysis and draft solution. Check for logical errors, omissions, and correctness.
2.  **Refine**: Based on your verification, create a final, comprehensive answer.
${reflectionConfig.enableErrorDetection ? '3.  **Correct**: Explicitly identify and correct any errors found in the draft.' : ''}
${reflectionConfig.enableAlternativeSearch ? '4.  **Consider Alternatives**: Briefly note if a more optimal approach exists.' : ''}
${reflectionConfig.enableConfidenceAssessment ? '5.  **State Confidence**: Conclude with your confidence level in the final answer.' : ''}
FORMAT:
#### STAGE 2 VERIFICATION
[Your critical analysis of the Stage 1 output.]
#### FINAL COMPREHENSIVE ANSWER
[The definitive, well-reasoned, and polished solution. This is the final output for the user.]`
    };

    // --- CORE LOGIC ---
    async function sendMessage(message) {
      addMessageToCurrentThread(message, "user");
      if (CONFIG.reasoningMethod === "standard") {
        await sendStandardMessage(message);
      } else {
        await sendEnhancedCoDMessage(message);
      }
    }

    async function sendStandardMessage(message) {
      addMessageToCurrentThread("Thinking...", "bot", true);
      const thread = getCurrentThread();
      const placeholderIndex = thread.messages.length - 1;
      try {
        const response = await callApi([{ role: "user", content: message }], CONFIG.stage1Model);
        thread.messages[placeholderIndex] = createBotMessage(response.content, { 
          modelName: "DeepSeek V3", totalTokens: response.usage?.total_tokens 
        });
      } catch (error) {
        thread.messages[placeholderIndex] = createBotMessage(`Error: ${error.message}`, { isError: true });
      }
      renderCurrentThreadMessages();
    }

    async function sendEnhancedCoDMessage(message) {
      const thread = getCurrentThread();
      const startTime = performance.now();
      showProgress(true, 0);

      try {
        // Stage 1: Draft
        addMessageToCurrentThread("S1 (DeepSeek): Drafting...", "bot", true);
        let placeholderIndex = thread.messages.length - 1;
        showProgress(true, 25);
        const stage1Prompt = PROMPTS.stage1(CONFIG.codWordLimit);
        const stage1Result = await callApi([{ role: "system", content: stage1Prompt }, { role: "user", content: message }], CONFIG.stage1Model);
        const stage1EndTime = performance.now();
        thread.messages[placeholderIndex] = createBotMessage(stage1Result.content, {
          stageType: 'stage1_draft', modelName: 'DeepSeek V3',
          duration: (stage1EndTime - startTime) / 1000, totalTokens: stage1Result.usage?.total_tokens
        });
        renderCurrentThreadMessages();
        
        // Stage 2: Refine
        addMessageToCurrentThread("S2 (Qwen3): Refining...", "bot", true);
        placeholderIndex = thread.messages.length - 1;
        showProgress(true, 75);
        const stage2Prompt = PROMPTS.stage2(CONFIG.reflectionSettings);
        const stage2UserContent = `USER PROBLEM:\n${message}\n\nSTAGE 1 DRAFT:\n${stage1Result.content}`;
        const stage2Result = await callApi([{ role: "system", content: stage2Prompt }, { role: "user", content: stage2UserContent }], CONFIG.stage2Model);
        const stage2EndTime = performance.now();
        thread.messages[placeholderIndex] = createBotMessage(stage2Result.content, {
          stageType: 'stage2_final', modelName: 'Qwen3',
          duration: (stage2EndTime - stage1EndTime) / 1000, totalTokens: stage2Result.usage?.total_tokens,
          totalProcessingTime: (stage2EndTime - startTime) / 1000
        });
        showProgress(true, 100);
        
      } catch (error) {
        console.error("CoD Error:", error);
        addMessageToCurrentThread(`Error during CoD process: ${error.message}`, "bot", false, { isError: true });
      } finally {
        renderCurrentThreadMessages();
        setTimeout(() => showProgress(false), 1000);
      }
    }

    async function callApi(messages, model) {
      const payload = { model, messages, temperature: CONFIG.temperature, top_p: CONFIG.topP, max_tokens: CONFIG.maxTokens, stream: false };
      const response = await fetch('/api/chat', {
        method: "POST", headers: { "Content-Type": "application/json" }, body: JSON.stringify(payload)
      });
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({ message: "Unknown API error" }));
        throw new Error(`API Error (${model}): ${response.status} ${errorData.message}`);
      }
      const data = await response.json();
      if (!data.choices?.[0]?.message) throw new Error("Invalid API response format");
      return { content: data.choices[0].message.content || "", usage: data.usage };
    }

    // --- UI & RENDERING ---
    function renderCurrentThreadMessages() {
      const chatMessagesDiv = document.getElementById("chatMessages");
      chatMessagesDiv.innerHTML = "";
      const thread = getCurrentThread();
      if (!thread) return;

      thread.messages.forEach(msg => {
        const messageDiv = document.createElement("div");
        messageDiv.className = `flex ${msg.sender === 'user' ? 'justify-end' : 'justify-start'}`;
        const msgContent = document.createElement("div");
        msgContent.className = "max-w-[90%] p-4 rounded-2xl shadow-md";

        if (msg.sender === 'user') {
          msgContent.className += " deepseek-gradient text-white rounded-tr-sm";
          msgContent.innerHTML = transformMessage(msg.content);
        } else {
          msgContent.className += " bg-dark-700 border border-dark-500 rounded-tl-sm";
          if (msg.isPlaceholder) {
            msgContent.innerHTML = `<div class="flex items-center gap-2 opacity-70"><svg class="animate-spin h-4 w-4 text-deepseek-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>${msg.content}</div>`;
          } else {
            msgContent.innerHTML = formatBotMessage(msg);
          }
        }
        messageDiv.appendChild(msgContent);
        chatMessagesDiv.appendChild(messageDiv);
      });
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
      document.querySelectorAll('pre').forEach(addCodeCopyButtons);
    }
    
    function formatBotMessage(msg) {
        let html = '';
        if (msg.stageType === 'stage1_draft') {
            const sections = msg.content.split('####');
            const analysis = sections[1]?.replace("PROBLEM ANALYSIS", "").trim();
            const steps = sections[2]?.replace("CHAIN OF DRAFT STEPS", "").trim();
            const solution = sections[3]?.replace("DRAFT SOLUTION", "").trim();
            html += `<div class="p-3 bg-blue-900/10 rounded-lg mb-3 verification-block"><h4 class="text-sm font-semibold text-blue-300 mb-2">S1: Problem Analysis</h4>${transformMessage(analysis)}</div>`;
            html += `<div class="p-3 bg-green-900/10 rounded-lg mb-3 verification-block"><h4 class="text-sm font-semibold text-green-300 mb-2">S1: Chain of Draft Steps</h4>${formatCoDSteps(steps)}</div>`;
            html += `<div class="p-3 bg-orange-900/10 rounded-lg verification-block"><h4 class="text-sm font-semibold text-orange-300 mb-2">S1: Draft Solution</h4>${transformMessage(solution)}</div>`;
        } else if (msg.stageType === 'stage2_final') {
            const sections = msg.content.split('####');
            const verification = sections[1]?.replace("STAGE 2 VERIFICATION", "").trim();
            const finalAnswer = sections[2]?.replace("FINAL COMPREHENSIVE ANSWER", "").trim();
            html += `<div class="p-3 bg-indigo-900/10 rounded-lg mb-3 final-answer"><h4 class="text-sm font-semibold text-indigo-300 mb-2">S2: Verification Analysis</h4>${transformMessage(verification)}</div>`;
            html += `<div class="p-3 bg-emerald-900/10 rounded-lg final-answer"><h4 class="text-sm font-semibold text-emerald-300 mb-2">S2: Final Comprehensive Answer</h4>${transformMessage(finalAnswer)}</div>`;
        } else {
            html += transformMessage(msg.content);
        }

        const stats = [];
        if(msg.modelName) stats.push(`Model: <span class="text-gray-300">${msg.modelName}</span>`);
        if(msg.duration) stats.push(`Time: <span class="text-amber-400">${msg.duration.toFixed(2)}s</span>`);
        if(msg.totalTokens) stats.push(`Tokens: <span class="text-teal-400">${msg.totalTokens}</span>`);
        if(msg.totalProcessingTime) stats.push(`Total Time: <span class="text-deepseek-400">${msg.totalProcessingTime.toFixed(2)}s</span>`);

        if(stats.length > 0) {
            html += `<div class="mt-3 pt-2 border-t border-dark-600/50 text-xs text-gray-400 flex flex-wrap gap-x-4 gap-y-1">${stats.join('')}</div>`;
        }
        return html;
    }

    function formatCoDSteps(stepsContent) {
        if (!stepsContent) return '';
        return stepsContent.split('\n').filter(line => line.trim().startsWith('CoD Step')).map((step, index) => {
            const stepText = step.replace(/^(cod step \d+:)/i, '').trim();
            return `<div class="flex items-start mb-2 cod-step"><span class="flex items-center justify-center min-w-8 h-8 mr-3 rounded-full bg-green-700 text-green-100 text-sm font-bold">${index + 1}</span><div class="font-mono text-sm">${stepText}</div></div>`;
        }).join('');
    }

    function addCodeCopyButtons(pre) {
      if (pre.querySelector('.copy-btn')) return;
      pre.classList.add('copy-btn-added');
      const btn = document.createElement('button');
      btn.textContent = 'Copy';
      btn.className = 'copy-btn';
      btn.onclick = () => {
        navigator.clipboard.writeText(pre.querySelector('code').textContent);
        btn.textContent = 'Copied!';
        setTimeout(() => (btn.textContent = 'Copy'), 2000);
      };
      pre.appendChild(btn);
    }

    // --- STATE & HELPERS ---
    const countWords = (text) => text ? (text.match(/\S+/g) || []).length : 0;
    const transformMessage = (content) => (typeof marked !== 'undefined') ? marked.parse(content) : content.replace(/\n/g, '<br>');
    const getCurrentThread = () => threads.find(t => t.id === currentThreadId);
    function showProgress(show, percentage) {
      const c = document.getElementById("progressContainer"), b = document.getElementById("progressBar");
      if(show) { c.classList.remove("hidden"); b.style.width = `${percentage}%`; }
      else { c.classList.add("hidden"); b.style.width = "0%"; }
    }
    
    function createBotMessage(content, options = {}) {
        return {
            content, sender: 'bot', timestamp: new Date(), isPlaceholder: false,
            wordCount: countWords(content), ...options
        };
    }
    function addMessageToCurrentThread(content, sender, isPlaceholder = false, options = {}) {
      const thread = getCurrentThread();
      if (thread) {
        thread.messages.push({ content, sender, isPlaceholder, timestamp: new Date(), ...options });
        renderCurrentThreadMessages();
      }
    }

    // --- INITIALIZATION ---
    function initApp() {
      loadPersistedSettings();
      createNewThread();
      initEventListeners();
    }

    function loadPersistedSettings() {
      try {
        const saved = localStorage.getItem("enhancedCodConfig");
        if(saved) {
            const parsed = JSON.parse(saved);
            Object.assign(CONFIG, parsed);
        }
        // Always enforce the correct models and word limit from the code on load
        CONFIG.stage1Model = "accounts/fireworks/models/deepseek-v3-0324";
        CONFIG.stage2Model = "accounts/fireworks/models/qwen3-30b-a3b";
        CONFIG.codWordLimit = 15;
      } catch (e) { console.warn("Could not load settings:", e); }
    }

    function createNewThread() {
      const newThread = {
        id: Date.now(), name: `Research Session ${threadCounter++}`, messages: [],
        metadata: { created: new Date().toISOString(), stage1Model: CONFIG.stage1Model, stage2Model: CONFIG.stage2Model }
      };
      threads.push(newThread);
      currentThreadId = newThread.id;
      updateThreadList();
      renderCurrentThreadMessages();
    }

    function updateThreadList() {
        const threadList = document.getElementById("threadList");
        threadList.innerHTML = "";
        threads.forEach(thread => {
            const li = document.createElement("li");
            li.className = `px-4 py-3 rounded-xl cursor-pointer hover:bg-dark-600 transition-all duration-200 border border-dark-500/50 ${thread.id === currentThreadId ? 'bg-dark-600/50 text-deepseek-300 border-deepseek-500/50' : 'text-gray-300'}`;
            li.innerHTML = `<div class="flex items-center gap-3"><div class="w-8 h-8 bg-deepseek-500/20 rounded-lg flex items-center justify-center"><svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-deepseek-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z"></path></svg></div><div class="flex-1 min-w-0"><p class="text-sm font-medium text-white truncate">${thread.name}</p></div></div>`;
            li.onclick = () => { currentThreadId = thread.id; updateThreadList(); renderCurrentThreadMessages(); };
            threadList.appendChild(li);
        });
        document.getElementById("threadCount").textContent = threads.length;
    }
    
    function initEventListeners() {
      const listen = (id, event, handler) => document.getElementById(id)?.addEventListener(event, handler);
      const userInput = document.getElementById('userInput');

      listen('sendBtn', 'click', () => { if (userInput.value.trim()) sendMessage(userInput.value.trim()); userInput.value = ''; });
      userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); listen('sendBtn', 'click', () => {}); document.getElementById('sendBtn').click(); }});
      userInput.addEventListener('input', () => { userInput.style.height = 'auto'; userInput.style.height = `${userInput.scrollHeight}px`; });
      
      listen('newThreadBtn', 'click', createNewThread);
      listen('clearThreadBtn', 'click', () => { if (confirm('Clear session?')) { getCurrentThread().messages = []; renderCurrentThreadMessages(); }});
      listen('deleteThreadBtn', 'click', () => { if (confirm('Delete session?')) { threads = threads.filter(t => t.id !== currentThreadId); currentThreadId = threads.length ? threads[0].id : null; if (!currentThreadId) createNewThread(); else { updateThreadList(); renderCurrentThreadMessages(); } }});
      
      // Settings Modal
      listen('openSettings', 'click', openSettingsModal);
      listen('closeModalX', 'click', closeSettingsModal);
      listen('closeSettings', 'click', closeSettingsModal);
      listen('saveSettings', 'click', saveSettings);
      window.addEventListener("click", (e) => { if (e.target.id === "settingsModal") closeSettingsModal(); });
      
      const tabButtons = document.querySelectorAll('.tab-btn');
      tabButtons.forEach(button => button.addEventListener('click', () => {
        tabButtons.forEach(btn => btn.classList.remove('bg-deepseek-500', 'text-white'));
        button.classList.add('bg-deepseek-500', 'text-white');
        document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
        document.getElementById(button.dataset.tab)?.classList.remove('hidden');
      }));

      document.querySelectorAll('input[type="range"]').forEach(slider => {
          const valueDisplay = document.getElementById(`${slider.id}Value`);
          const update = () => {
              if (valueDisplay) valueDisplay.textContent = slider.value;
              updateRangeColor(slider);
          };
          slider.addEventListener('input', update);
          update();
      });
    }

    function openSettingsModal() {
        document.getElementById('enhancedCod').checked = CONFIG.reasoningMethod === 'enhanced_cod';
        document.getElementById('standardReasoning').checked = CONFIG.reasoningMethod === 'standard';
        document.getElementById('cod15Words').checked = true; // Always 15

        Object.entries(CONFIG.reflectionSettings).forEach(([key, value]) => {
            const el = document.getElementById(`enable${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (el) el.checked = value;
        });

        document.getElementById('temp').value = CONFIG.temperature;
        document.getElementById('topP').value = CONFIG.topP;
        document.getElementById('maxTokens').value = CONFIG.maxTokens;
        document.querySelectorAll('input[type="range"]').forEach(s => s.dispatchEvent(new Event('input'))); // Trigger update
        document.getElementById('settingsModal').style.display = 'flex';
    }

    function closeSettingsModal() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    function saveSettings() {
        CONFIG.reasoningMethod = document.getElementById('enhancedCod').checked ? 'enhanced_cod' : 'standard';
        Object.keys(CONFIG.reflectionSettings).forEach(key => {
            const el = document.getElementById(`enable${key.charAt(0).toUpperCase() + key.slice(1)}`);
            if (el) CONFIG.reflectionSettings[key] = el.checked;
        });
        CONFIG.temperature = parseFloat(document.getElementById('temp').value);
        CONFIG.topP = parseFloat(document.getElementById('topP').value);
        CONFIG.maxTokens = parseInt(document.getElementById('maxTokens').value);
        
        localStorage.setItem("enhancedCodConfig", JSON.stringify(CONFIG));
        closeSettingsModal();
    }
    
    document.addEventListener("DOMContentLoaded", initApp);
  </script>
</body>
</html>
